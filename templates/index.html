<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unbait those clicks!</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="flex gap-8">
        <!-- Left sidebar with stored summaries -->
        <div class="w-1/3">
            <div class="bg-white shadow-md rounded px-6 py-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Stored Summaries</h2>
                <div class="space-y-2">
                    {% for summary in stored_summaries %}
                    <div class="group flex items-center justify-between p-3 hover:bg-gray-50 rounded transition-colors duration-150">
                        <div class="cursor-pointer flex-grow" onclick="loadSummary('{{ summary.video_id }}')">
                            <h3 class="font-semibold text-gray-700">{{ summary.title }}</h3>
                            <p class="text-sm text-gray-500">Saved {{ summary.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <button onclick="deleteSummary('{{ summary.video_id }}', this)" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="w-2/3">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Unbait those clicks! üé£</h1>
            
            <form id="summaryForm" method="POST" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="video_url">
                        YouTube URL
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="video_url" 
                           name="video_url" 
                           type="text" 
                           placeholder="Enter YouTube URL">
                </div>
                <div class="flex items-center justify-between">
                    <button id="submitBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" 
                            type="submit">
                        Get Summary
                    </button>
                </div>
            </form>

            <!-- Loading Indicator -->
            <div id="loading" class="hidden">
                <div class="bg-white shadow-md rounded px-8 py-6 mb-4">
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <span class="ml-2 text-gray-600">Generating summary...</span>
                    </div>
                </div>
            </div>

            {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline">{{ error }}</span>
            </div>
            {% endif %}

            <div id="summaryContent">
                {% if title and summary %}
                <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">{{ title }}</h2>
                    {% if duration_minutes > 0 %}
                    <div class="mb-4 text-green-600 font-semibold">
                        You just saved {{ duration_minutes }} minutes! üéâ
                    </div>
                    {% endif %}
                    <p class="text-gray-600 whitespace-pre-line">{{ summary | safe }}</p>
                </div>
                {% endif %}

                {% if analysis %}
                <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Should You Watch? ü§î</h3>
                    <div class="prose">
                        {% set first_line = analysis.split('<br>')[0] %}
                        {% if 'Watch: YES' in first_line %}
                            <p class="text-green-600 font-bold text-lg mb-4">{{ first_line }} üëç</p>
                        {% elif 'Watch: NO' in first_line %}
                            <p class="text-red-600 font-bold text-lg mb-4">{{ first_line }} üëé</p>
                        {% endif %}
                        {{ analysis.replace(first_line + '<br>', '') | safe }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        document.getElementById('summaryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Show loading indicator
            document.getElementById('loading').classList.remove('hidden');
            // Disable submit button
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const formData = new FormData(this);
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Add new summary to the list
                const summariesList = document.querySelector('.space-y-2');
                const newSummaryHtml = `
                    <div class="group flex items-center justify-between p-3 hover:bg-gray-50 rounded transition-colors duration-150">
                        <div class="cursor-pointer flex-grow" onclick="loadSummary('${data.video_id}')">
                            <h3 class="font-semibold text-gray-700">${data.title}</h3>
                            <p class="text-sm text-gray-500">Saved ${data.created_at}</p>
                        </div>
                        <button onclick="deleteSummary('${data.video_id}', this)" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity duration-150 text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                summariesList.insertAdjacentHTML('afterbegin', newSummaryHtml);
                
                // Update the summary content
                const summaryContent = document.getElementById('summaryContent');
                summaryContent.innerHTML = `
                    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4" data-video-id="${data.video_id}">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">${data.title}</h2>
                        ${data.duration_minutes > 0 ? `
                            <div class="mb-4 text-green-600 font-semibold">
                                You just saved ${data.duration_minutes} minutes! üéâ
                            </div>
                        ` : ''}
                        <p class="text-gray-600 whitespace-pre-line">${data.summary}</p>
                    </div>
                    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Should You Watch? ü§î</h3>
                        <div class="prose">
                            ${data.analysis}
                        </div>
                    </div>
                `;
                
                // Clear the form
                this.reset();
            } catch (error) {
                console.error('Error:', error);
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative';
                errorDiv.innerHTML = `<span class="block sm:inline">Error processing video: ${error.message}</span>`;
                document.getElementById('summaryContent').prepend(errorDiv);
            } finally {
                // Hide loading indicator and enable submit button
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        async function deleteSummary(videoId, button) {
            if (!confirm('Are you sure you want to delete this summary?')) {
                return;
            }

            try {
                const response = await fetch(`/summary/${videoId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Remove the summary item from the list
                const summaryItem = button.closest('.group');
                summaryItem.remove();

                // If this was the currently displayed summary, clear the content
                const summaryContent = document.getElementById('summaryContent');
                if (summaryContent.querySelector(`[data-video-id="${videoId}"]`)) {
                    summaryContent.innerHTML = '';
                }
            } catch (error) {
                console.error('Error deleting summary:', error);
                alert('Error deleting summary: ' + error.message);
            }
        }

        async function loadSummary(videoId) {
            try {
                const response = await fetch(`/summary/${videoId}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error(data.error);
                    return;
                }

                const summaryContent = document.getElementById('summaryContent');
                summaryContent.innerHTML = `
                    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4" data-video-id="${videoId}">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">${data.title}</h2>
                        ${data.duration_minutes > 0 ? `
                            <div class="mb-4 text-green-600 font-semibold">
                                You just saved ${data.duration_minutes} minutes! üéâ
                            </div>
                        ` : ''}
                        <p class="text-gray-600 whitespace-pre-line">${data.summary}</p>
                    </div>
                    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Should You Watch? ü§î</h3>
                        <div class="prose">
                            ${data.analysis}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }
    </script>
</body>
</html>